---
import Layout from "../../layouts/Layout.astro";
import PromiseSection from "../../components/services/Promise.astro";
import OffersSpecialsFinancing from "../../components/OffersSpecialsFinancing.astro";
import { Icon } from "astro-icon/components";
import { getImageUrl, processMarkdown } from "../../utils/payload";
import OfferCard from "../../components/OfferCard.astro";


// Assets fallback
import heroImageFallback from "../../assets/plan-2.jpg";
import toolsImageFallback from "../../assets/mano.png";
import OffersSpecials from "@/components/services/OffersSpecials.astro";

const API_URL = import.meta.env.PUBLIC_API_URL;

// Fetch Financing Page Data
const getFinancingPage = async () => {
  try {
    const res = await fetch(
      `${API_URL}/api/financing-pages?where[serviceType][equals]=plumbing&depth=2`
    );
    const data = await res.json();
    return data.docs?.[0] || null;
  } catch (error) {
    console.error("Error fetching financing page:", error);
    return null;
  }
};

// Fetch Offers
const getOffers = async (serviceType?: string) => {
  try {
    let url = `${API_URL}/api/offers?where[active][equals]=true&limit=100&sort=createdAt&depth=2`;
    if (serviceType) {
      url += `&where[serviceType][equals]=${serviceType}`;
    }
    const res = await fetch(url);
    const data = await res.json();
    return data.docs || [];
  } catch (error) {
    console.error("Error fetching offers:", error);
    return [];
  }
};

// Fetch Features
const getFeatures = async () => {
  try {
    const res = await fetch(`${API_URL}/api/features?limit=100`);
    const data = await res.json();
    return data.docs || [];
  } catch (error) {
    console.error("Error fetching features:", error);
    return [];
  }
};

const pageData = await getFinancingPage();
const offers = await getOffers(pageData?.offersSection?.filterByServiceType ? "plumbing" : undefined);
const allFeatures = await getFeatures();

// Resolve features relationship
const resolveFeatures = (featureRefs: any[]) => {
  if (!featureRefs || !Array.isArray(featureRefs)) return [];
  return featureRefs.map((ref: any) => {
    if (typeof ref === 'object' && ref.text) return ref;
    const found = allFeatures.find((f: any) => f.id === ref || f.id === ref?.id);
    return found || { text: ref };
  }).filter(Boolean);
};

// Fallback data if no CMS data
const hero = pageData?.hero || {
  heading: "Plumbing Finance Options Near Warwick, RI",
  ctaText: "Our Financing Options & Plans",
  ctaLink: "#financing-details",
};

const infoSection = pageData?.infoSection || {
  enabled: true,
  faqs: [
    {
      question: "Do some plumbers offer payment plans or financing options?",
      answer: "At Evergreen Services, we partner with the top finance companies in the country to offer financing for our customers' plumbing needs. There typically is no difference between using financing offered by a plumber and obtaining your own financing directly with a lender, so let us help make your next plumbing service easy. Call us today!",
    },
    {
      question: "What plumbing services can I finance?",
      answer: "We finance most plumbing services. If you are looking for financing options for anything from a new toilet or kitchen sink, to a new water heater or whole home repiping, Evergreen Services can help you with your entire project. From helping you through the financing process to completion of your plumbing service, we are here for you!",
    },
    {
      question: "Do plumbers near me offer financing for plumbing services?",
      answer: 'Short answer, YES! Evergreen Services offers plumbing finance solutions for your plumbing needs. We have short term and longer-term finance options. Depending on your finance needs, we can help you with a personalized finance plan for your plumbing projects. Call us today at <a href="tel:4013563094" class="font-bold hover:underline">(401) 356-3094</a> and let our team create finance options for your plumbing service needs.',
    },
  ],
};

const offersSection = pageData?.offersSection || {
  enabled: true,
  heading: "All Plumbing Coupons & Special Offers from Evergreen Services",
  disclaimer: "* Call for Conditions & Restrictions / Present Coupon at Time of Service / Not Available to Combine with Other Offers Offer must be presented to Techs before any work begins *",
};

// Build promise section with resolved features
const promiseSection = {
  enabled: pageData?.promiseSection?.enabled ?? true,
  firstBlock: {
    heading: pageData?.promiseSection?.firstBlock?.heading || "Our Promise to You is to Perform the Correct Plumbing Service at an Honest Price",
    content: pageData?.promiseSection?.firstBlock?.content || `When you need plumbing services, trust the experts at Evergreen Services. Our plumbers have the skills, knowledge, and tools to fix most problems on the spot.

When your Evergreen Services plumber arrives at your home they will explain all of your options before plumbing repairs so you can make informed decisions before any work begins. We service and repair most brands of equipment, so you can trust us to perform a professional job.`,
    image: pageData?.promiseSection?.firstBlock?.image,
    cta: pageData?.promiseSection?.firstBlock?.cta || {
      text: "Schedule Now",
      link: "/contact",
      icon: "calendar",
    },
  },
  secondBlock: {
    heading: pageData?.promiseSection?.secondBlock?.heading || "Evergreen Services is Here for All of Your Needs!",
    features: resolveFeatures(pageData?.promiseSection?.secondBlock?.features) || [
      { text: "Upfront pricing – you'll never pay more than you're quoted" },
      { text: "Expert advice from professional, licensed & certified technicians" },
      { text: "We'll only sell you what you need" },
      { text: "We stock enough parts in our trucks to do 93% of repairs on the spot" },
      { text: "We stand by all recommended repairs" },
      { text: "Flexible scheduling, ask about same-day service!" },
    ],
    image: pageData?.promiseSection?.secondBlock?.image,
    contactText: pageData?.promiseSection?.secondBlock?.contactText || "Still have questions? Contact Us for all your questions!",
    bottomText: pageData?.promiseSection?.secondBlock?.bottomText || "Evergreen Services is Proudly & Professionally Offering Plumbing Services in the Warwick, RI area.",
    cta: pageData?.promiseSection?.secondBlock?.cta || {
      text: "SEE ALL OFFERS!",
      link: "/offers",
    },
  },
};

const heroImage = hero.backgroundImage ? getImageUrl(hero.backgroundImage) : heroImageFallback.src;
const toolsImage = infoSection.image ? getImageUrl(infoSection.image) : toolsImageFallback.src;

const seoTitle = pageData?.seo?.metaTitle || "Plumbing Finance Options | Evergreen Services";
---

<Layout title={seoTitle} navbarBG={true}>
  <main class="bg-white">
    <!-- Hero Section -->
    <section class="relative h-[50vh] min-h-[400px] flex items-center justify-center mt-20">
      <div class="absolute inset-0 z-0">
        <img
          src={heroImage}
          alt={hero.heading}
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-black/60"></div>
      </div>

      <div class="relative z-10 container mx-auto px-6 text-center flex flex-col items-center gap-4">
        <div class="flex items-center gap-2 text-sm text-neutral-300">
          <a href="/" class="hover:text-evergreen-primary transition-colors">Home</a>
          <span>›</span>
          <a href="/plumbing-services" class="hover:text-evergreen-primary transition-colors">Plumbing</a>
          <span>›</span>
          <span>Plumbing Financing</span>
        </div>

        <h1 class="text-white text-2xl lg:text-4xl font-bold max-w-3xl leading-tight">
          {hero.heading}
        </h1>

        <a
          href={hero.ctaLink || "#financing-details"}
          class="bg-evergreen-primary hover:bg-evergreen-600 text-white px-6 py-3 rounded-full font-bold text-base transition-colors shadow-lg"
        >
          {hero.ctaText}
        </a>
      </div>
    </section>

    <!-- Info Section (Green Background) -->
    {infoSection.enabled !== false && (
      <section id="financing-details" class="bg-evergreen-primary py-12 lg:py-20 overflow-hidden">
        <div class="container mx-auto px-6">
          <div class="flex flex-col lg:flex-row items-center gap-10 lg:gap-16">
            <!-- Text Content -->
            <div class="w-full lg:w-1/2 text-white flex flex-col gap-6">
              {infoSection.faqs?.map((faq: { question: string; answer: any }) => (
                <div>
                  <h3 class="text-xl lg:text-2xl font-bold mb-3">
                    {faq.question}
                  </h3>
                  {typeof faq.answer === "string" ? (
                    <p class="text-white/90 leading-relaxed text-sm lg:text-base" set:html={faq.answer} />
                  ) : (
                    <div class="text-white/90 leading-relaxed text-sm lg:text-base" set:html={processMarkdown(faq.answer)} />
                  )}
                </div>
              ))}
            </div>

            <!-- Image -->
            <div class="w-full lg:w-1/2 flex justify-center lg:justify-end">
              <img
                src={toolsImage}
                alt="Plumbing Tools"
                class="w-full max-w-sm lg:max-w-md h-auto object-contain drop-shadow-2xl"
              />
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Offers Section -->
    {offersSection.enabled !== false && offers.length > 0 && (
      <OffersSpecials
        heading={offersSection.heading}
        offers={offers}
        disclaimer={offersSection.disclaimer}
      />
    )}

    <!-- Promise Section -->
    {promiseSection.enabled !== false && (
      <PromiseSection promiseSection={promiseSection} />
    )}
  </main>
</Layout>