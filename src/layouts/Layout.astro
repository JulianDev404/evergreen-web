---
import "../styles/global.css";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import ChatButton from "../components/ChatButton.astro";
import RecaptchaScript from "../components/RecaptchaScript.astro";
import { getImageUrl } from "@/utils/payload";
import ContactModal from "../components/ContactModal.astro";

interface Props {
  seoData?: {
    metaTitle?: string;
    metaDescription?: string;
    keywords?: string;
    schemaMarkup?: string;
  };
  navbarBG?: boolean;
}

const API_URL = import.meta.env.PUBLIC_API_URL;
const { seoData, navbarBG = false } = Astro.props;

const getSiteSettings = async () => {
  const res = await fetch(`${API_URL}/api/globals/site-settings?depth=2`);
  const data = await res.json();
  return data;
};

const siteSettings = await getSiteSettings();
const { company, contact, socialMedia } = siteSettings;

// Valores por defecto si seoData no existe o está incompleto
const metaTitle = seoData?.metaTitle || "Evergreen Services RI";
const metaDescription = seoData?.metaDescription || "";
const keywords = seoData?.keywords;
const schemaMarkup = seoData?.schemaMarkup;

// URL canónica de la página actual
const canonicalURL = Astro.url.href;

// ============================================
// SCHEMA: Manual o Auto-generado
// ============================================
const generateAutoSchema = () => {
  return {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    name: company?.name || "Evergreen Services",
    description: metaDescription,
    url: Astro.url.origin,
    telephone: contact?.phone,
    email: contact?.email,
    address: {
      "@type": "PostalAddress",
      streetAddress: contact?.address?.street,
      addressLocality: contact?.address?.city,
      addressRegion: contact?.address?.state || "RI",
      postalCode: contact?.address?.zip,
      addressCountry: "US",
    },
    logo: company?.logo ? getImageUrl(company.logo) : undefined,
    image: company?.logo ? getImageUrl(company.logo) : undefined,
    priceRange: "$$",
    sameAs: [
      socialMedia?.facebook,
      socialMedia?.instagram,
      socialMedia?.twitter,
      socialMedia?.linkedin,
      socialMedia?.youtube,
      socialMedia?.yelp,
      socialMedia?.googleBusiness,
    ].filter(Boolean),
  };
};

let finalSchema = null;
if (schemaMarkup) {
  try {
    finalSchema =
      typeof schemaMarkup === "string"
        ? JSON.parse(schemaMarkup)
        : schemaMarkup;
  } catch (e) {
    console.error("Error parsing schema:", e);
    finalSchema = generateAutoSchema();
  }
} else {
  finalSchema = generateAutoSchema();
}

// Limpiar campos undefined
finalSchema = JSON.parse(JSON.stringify(finalSchema));
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Basic Meta Tags -->
    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    {keywords && <meta name="keywords" content={keywords} />}

    <!-- Canonical -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph -->
    <meta property="og:site_name" content="Evergreen Services RI" />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />

    <!-- Favicon -->
    <link
      rel="icon"
      type={company?.favicon?.mimeType}
      href={getImageUrl(company?.favicon)}
    />

    <!-- Google Schema JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(finalSchema)} />

    <RecaptchaScript />
  </head>
  <body class="min-h-screen flex flex-col bg-white">
    <Navbar navbarBG={navbarBG} />
    <main class="flex-1 bg-black overflow-hidden">
      <slot />
    </main>
    <Footer />
    <ContactModal company={siteSettings.company} getImageUrl={getImageUrl} />
  </body>
</html>
