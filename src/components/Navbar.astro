---
// apps/web/src/components/Header.astro
import { Icon } from "astro-icon/components";
import { buildNavigationMenu } from "../utils/navigation";
import DynamicIcon from "./DynamicIcon.astro";
import { getImageUrl } from "../utils/payload";

interface Props {
  navbarBG?: boolean;
}

const { navbarBG = false } = Astro.props;
const API_URL = import.meta.env.PUBLIC_API_URL;

// Obtener navegación
const getNavigation = async () => {
  const res = await fetch(`${API_URL}/api/globals/navigation?depth=2`);
  const data = await res.json();
  return data;
};

// Obtener la configuración del sitio
const getSiteSettings = async () => {
  const res = await fetch(`${API_URL}/api/globals/site-settings?depth=2`);
  const data = await res.json();
  return data;
};

const [navigation, siteSettings] = await Promise.all([
  getNavigation(),
  getSiteSettings(),
]);

const { company, contact, socialMedia, footer, legal, payment } = siteSettings;

const { searchPlaceholder, ctaButton } = navigation;

const menuItems = await buildNavigationMenu(navigation.menuItems || []);

const initialBgClass = navbarBG ? "bg-black" : "bg-transparent";
---

<header
  id="main-header"
  data-initial-bg={navbarBG ? "black" : "transparent"}
  class={`fixed top-0 z-50 w-full transition-colors duration-300 ${initialBgClass}`}
>
  <div class="mx-auto px-5 py-4">
    <div class="flex items-center justify-between gap-6">
      <!-- Logo -->
      <a href="/" class="flex-shrink-0">
        {
          company.logo && (
            <img
              src={getImageUrl(company.logo)}
              alt={company.companyName}
              class="h-12 w-auto"
            />
          )
        }
      </a>

      <!-- Search Bar -->
      <!-- <div class="hidden lg:flex flex-1 max-w-sm">
        <div class="relative w-full">
          <input
            type="text"
            placeholder={searchPlaceholder || "What's the problem at home?"}
            class="w-full px-5 py-2.5 pr-12 rounded-full bg-white text-neutral-800 placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-evergreen-primary text-sm"
          />
          <button
            type="button"
            aria-label="Search"
            class="absolute right-1 top-1/2 -translate-y-1/2 bg-evergreen-primary hover:bg-evergreen-primary/90 text-white w-9 h-9 rounded-full flex items-center justify-center transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
      </div> -->

      <!-- Navigation Desktop -->
      <nav class="hidden xl:flex items-center gap-1">
        {
          menuItems
            .sort((a: any, b: any) => a.order - b.order)
            .map((item: any) => (
              <div class="relative group">
                {item.subItems && item.subItems.length > 0 ? (
                  <div>
                    <button class="cursor-pointer text-white hover:text-evergreen-primary transition-colors px-4 py-2 text-sm font-medium flex items-center gap-1.5">
                      {item.label}
                      <div class="transition-transform group-hover:rotate-180">
                        <Icon name="arrow-down" size={10} />
                      </div>
                    </button>

                    {/* Submenu Principal con flecha */}
                    <div class="absolute left-0 mt-1 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-100">
                      {/* Flecha superior */}
                      <div class="relative">
                        <div class="absolute -top-2 left-6 w-4 h-4 bg-white rotate-45 shadow-lg" />
                      </div>

                      {/* Contenedor del menú con padding */}
                      <div class="relative w-70 bg-white rounded-lg shadow-2xl overflow-hidden p-2">
                        {item.subItems.map((subItem: any) => (
                          <div class="relative">
                            {subItem.children && subItem.children.length > 0 ? (
                              <div class="group/nested">
                                <div
                                  class={`flex items-center justify-between px-3 py-2.5 rounded-lg transition-all text-neutral-400 hover:bg-[#0A3C02] hover:text-[#44EE5B] cursor-pointer `}
                                >
                                  <div class="flex items-center gap-2.5">
                                    <div>
                                      <DynamicIcon
                                        icon={subItem.icon}
                                        size={20}
                                      />
                                    </div>
                                    <span class="text-sm font-medium">
                                      {subItem.label}
                                    </span>
                                  </div>
                                  <div class="text-neutral-400 group-hover/nested:text-white">
                                    <Icon name="chevron-right" size={12} />
                                  </div>
                                </div>

                                {/* Submenu Secundario */}
                                <div
                                  class="fixed opacity-0 invisible group-hover/nested:opacity-100 group-hover/nested:visible transition-all duration-200 z-[101]"
                                  style="left: calc(var(--submenu-left) + 17rem + 0.5rem); top: var(--submenu-top);"
                                >
                                  <div class="w-56 bg-white rounded-lg shadow-2xl overflow-hidden p-2">
                                    {subItem.children.map((childItem: any) => (
                                      <a
                                        href={childItem.url}
                                        class="flex items-center gap-2.5 px-3 py-2.5 rounded-lg transition-all text-neutral-400 hover:bg-[#0A3C02] hover:text-[#44EE5B]"
                                      >
                                        <div class="text-current">
                                          <DynamicIcon
                                            icon={childItem.icon}
                                            size={20}
                                          />
                                        </div>
                                        <span class="text-sm font-medium">
                                          {childItem.label}
                                        </span>
                                      </a>
                                    ))}
                                  </div>
                                </div>
                              </div>
                            ) : (
                              <a
                                href={subItem.url}
                                class="flex items-center justify-between px-3 py-2.5 rounded-lg transition-all text-neutral-400 hover:bg-[#0A3C02] hover:text-[#44EE5B] block"
                              >
                                <div class="flex items-center justify-center gap-2.5">
                                  <div class="text-current">
                                    <DynamicIcon
                                      icon={subItem.icon}
                                      size={20}
                                      class="hover:text-[#44EE5B]"
                                    />
                                  </div>
                                  <span class="text-sm font-medium">
                                    {subItem.label}
                                  </span>
                                </div>
                              </a>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                ) : (
                  <a
                    href={item.url}
                    class="text-white hover:text-evergreen-primary transition-colors px-4 py-2 text-sm font-medium block"
                  >
                    {item.label}
                  </a>
                )}
              </div>
            ))
        }
      </nav>

      <!-- Contact Actions -->
      <div class="flex items-center gap-3">
        <!-- Email Button -->
        <button
          type="button"
          onclick="openContactModal()"
          class="cursor-pointer hidden lg:flex items-center justify-center w-11 h-11 bg-transparent border-2 border-white hover:bg-white hover:text-black rounded-full transition-all group"
          aria-label="Email us"
        >
          <Icon name="email" size={20} class="text-white hover:text-black" />
        </button>

        <!-- Call Now Button -->
        <a
          href={`tel:${contact.phone.replace(/\D/g, "")}`}
          class="hidden xl:flex items-center gap-2 bg-evergreen-primary hover:bg-evergreen-primary/90 text-white px-5 py-2.5 rounded-full font-bold transition-colors text-sm shadow-lg"
        >
          <Icon name="phone-add" size={20} />
          <span>{ctaButton.text}</span>
        </a>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-button"
          class="xl:hidden text-white p-2"
          aria-label="Toggle menu"
        >
          <svg
            id="hamburger-icon"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Mobile Menu Full Screen -->
<div
  id="mobile-menu"
  class="fixed inset-0 bg-black z-[60] hidden xl:hidden overflow-y-auto"
>
  <!-- Mobile Header -->
  <div class="flex items-center justify-between px-5 py-4">
    <a href="/" class="flex-shrink-0">
      {
        company.logo && (
          <img
            src={getImageUrl(company.logo)}
            alt={company.companyName}
            class="h-12 w-auto"
          />
        )
      }
    </a>
    <button
      id="mobile-menu-close"
      class="text-white p-2"
      aria-label="Close menu"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Mobile Navigation -->
  <div class="px-5 pt-8 pb-8">
    <nav class="flex flex-col">
      {
        menuItems
          .sort((a: any, b: any) => a.order - b.order)
          .map((item: any) => (
            <div class="mobile-menu-item">
              {item.subItems && item.subItems.length > 0 ? (
                <details class="group">
                  <summary class="flex items-center justify-between py-4 cursor-pointer list-none">
                    <span class="text-white font-bold text-xl">
                      {item.label}
                    </span>
                    <svg
                      class="w-6 h-6 text-neutral-400 transition-transform group-open:rotate-180"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </summary>

                  <div class="pb-4">
                    {item.subItems.map((subItem: any) => (
                      <div>
                        {subItem.children && subItem.children.length > 0 ? (
                          <div class="bg-neutral-900 rounded-xl mb-3 overflow-hidden">
                            {/* Category Header with icon and line */}
                            <div class="px-4 pt-4 pb-3">
                              <div class="flex items-center gap-3 pb-3 border-b border-neutral-700">
                                <DynamicIcon
                                  icon={subItem.icon}
                                  size={20}
                                  class="text-white"
                                />
                                <span class="text-white font-bold text-sm uppercase tracking-wider">
                                  {subItem.label}
                                </span>
                              </div>
                            </div>

                            {/* Children Items - no dividers between them */}
                            <div class="px-4 pb-2">
                              {subItem.children.map((childItem: any) => (
                                <a
                                  href={childItem.url}
                                  class="flex items-center justify-between py-3 text-neutral-300 hover:text-white transition-colors"
                                >
                                  <span class="text-base">
                                    {childItem.label}
                                  </span>
                                  <svg
                                    class="w-5 h-5 text-neutral-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M9 5l7 7-7 7"
                                    />
                                  </svg>
                                </a>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <a
                            href={subItem.url}
                            class="flex items-center gap-3 py-3 px-2 text-neutral-300 hover:text-white transition-colors"
                          >
                            <DynamicIcon
                              icon={subItem.icon}
                              size={18}
                              class="text-neutral-400"
                            />
                            <span class="text-sm">{subItem.label}</span>
                          </a>
                        )}
                      </div>
                    ))}
                  </div>
                </details>
              ) : (
                <details class="group">
                  <summary class="flex items-center justify-between py-4 cursor-pointer list-none">
                    <span class="text-white font-bold text-xl">
                      {item.label}
                    </span>
                    <svg
                      class="w-6 h-6 text-neutral-400 transition-transform group-open:rotate-180"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </summary>
                  {/* Empty state or link to main page */}
                  <div class="pb-4">
                    {/* <a
                      href={item.url}
                      class="flex items-center justify-between py-3 px-4 text-neutral-300 hover:text-white transition-colors bg-neutral-900 rounded-xl"
                    >
                      <span class="text-base">View {item.label}</span>
                      <svg
                        class="w-5 h-5 text-neutral-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 5l7 7-7 7"
                        />
                      </svg>
                    </a> */}
                  </div>
                </details>
              )}
            </div>
          ))
      }
    </nav>

    <!-- Social Media Icons -->
    <div class="flex items-center justify-center gap-8 mt-16">
      {
        socialMedia.facebook && (
          <a
            href={socialMedia.facebook}
            class="text-white hover:text-evergreen-primary transition-colors"
            aria-label="Facebook"
          >
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
            </svg>
          </a>
        )
      }
      {
        socialMedia.instagram && (
          <a
            href={socialMedia.instagram}
            class="text-white hover:text-evergreen-primary transition-colors"
            aria-label="Instagram"
          >
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
            </svg>
          </a>
        )
      }
      {
        socialMedia.twitter && (
          <a
            href={socialMedia.twitter}
            class="text-white hover:text-evergreen-primary transition-colors"
            aria-label="X (Twitter)"
          >
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
            </svg>
          </a>
        )
      }
    </div>
  </div>
</div>

<script>
  // Mobile menu toggle
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenuClose = document.getElementById("mobile-menu-close");
  const mobileMenu = document.getElementById("mobile-menu");
  const hamburgerIcon = document.getElementById("hamburger-icon");
  const body = document.body;

  const header = document.getElementById("main-header");
  const initialBg = header?.dataset.initialBg;

  const setBg = (bg = initialBg) => {
    header?.classList.remove("bg-black", "bg-transparent");
    header?.classList.add(bg === "black" ? "bg-black" : "bg-transparent");
  };

  function openMobileMenu() {
    mobileMenu?.classList.remove("hidden");
    body.classList.add("overflow-hidden");
  }

  function closeMobileMenu() {
    mobileMenu?.classList.add("hidden");
    body.classList.remove("overflow-hidden");
  }

  mobileMenuButton?.addEventListener("click", openMobileMenu);
  mobileMenuClose?.addEventListener("click", closeMobileMenu);

  // Close menu when clicking a link
  mobileMenu?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", closeMobileMenu);
  });

  // Scroll effect
  window.addEventListener("scroll", () => {
    if (!header) return;

    if (window.scrollY > 50) {
      setBg("black");
    } else {
      setBg(initialBg);
    }
  });

  // Posicionar submenús secundarios (desktop)
  document.querySelectorAll(".group\\/nested").forEach((item) => {
    item.addEventListener("mouseenter", function (e) {
      const rect = this.getBoundingClientRect();
      const submenu = this.querySelector('[style*="--submenu"]');
      if (submenu) {
        submenu.style.setProperty("--submenu-left", `${rect.left}px`);
        submenu.style.setProperty("--submenu-top", `${rect.top}px`);
      }
    });
  });
</script>
