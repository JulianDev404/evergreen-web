---
// ContactModal.astro
interface Props {
  company: any;
  getImageUrl: (image: any) => string;
}

import plumberImage from "../assets/plumbing.png";

const { company, getImageUrl } = Astro.props;
---

<div
  id="contact-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/70" id="modal-backdrop"></div>

  <!-- Modal Content -->
  <div
    class="relative flex w-[900px] max-w-[90vw] h-[85vh] max-h-[700px] rounded-2xl overflow-hidden shadow-2xl"
  >
    <!-- Left Side - Form -->
    <div class="w-1/2 h-full bg-black flex items-center justify-center p-10">
      <div class="w-full max-w-sm">
        <!-- Logo -->
        <div class="flex justify-center mb-6">
          <img
            src={getImageUrl(company.logo)}
            alt={company.name}
            class="h-12 w-auto"
          />
        </div>

        <!-- Form -->
        <form id="contact-form-modal" class="space-y-3">
          <div>
            <label class="text-white text-sm mb-1 block">
              First Name <span class="text-evergreen-primary ml-0.5">*</span>
            </label>
            <input
              type="text"
              name="firstName"
              placeholder="e.g., John"
              required
              class="w-full px-4 py-3 rounded-lg bg-secondary-900 border border-secondary-700 text-white placeholder-secondary-400 focus:outline-none focus:ring-2 focus:ring-evergreen-primary text-sm"
            />
          </div>

          <div>
            <label class="text-white text-sm mb-1 block">
              Last Name <span class="text-evergreen-primary ml-0.5">*</span>
            </label>
            <input
              type="text"
              name="lastName"
              placeholder="e.g., Smith"
              required
              class="w-full px-4 py-3 rounded-lg bg-secondary-900 border border-secondary-700 text-white placeholder-secondary-400 focus:outline-none focus:ring-2 focus:ring-evergreen-primary text-sm"
            />
          </div>

          <div>
            <label class="text-white text-sm mb-1 block">
              Email <span class="text-evergreen-primary ml-0.5">*</span>
            </label>
            <input
              type="email"
              name="email"
              placeholder="e.g., john.smith@email.com"
              required
              class="w-full px-4 py-3 rounded-lg bg-secondary-900 border border-secondary-700 text-white placeholder-secondary-400 focus:outline-none focus:ring-2 focus:ring-evergreen-primary text-sm"
            />
          </div>

          <div>
            <label class="text-white text-sm mb-1 block"> Phone Number </label>
            <input
              type="tel"
              name="phone"
              placeholder="e.g., (401) 293-2048"
              class="w-full px-4 py-3 rounded-lg bg-secondary-900 border border-secondary-700 text-white placeholder-secondary-400 focus:outline-none focus:ring-2 focus:ring-evergreen-primary text-sm"
            />
          </div>

          <div>
            <label class="text-white text-sm mb-1 block">Postal Code</label>
            <input
              type="text"
              name="postalCode"
              placeholder="e.g., 02903"
              class="w-full px-4 py-3 rounded-lg bg-secondary-900 border border-secondary-700 text-white placeholder-secondary-400 focus:outline-none focus:ring-2 focus:ring-evergreen-primary text-sm"
            />
          </div>

          <div>
            <label class="text-white text-sm mb-1 block">
              How we can help you
            </label>
            <textarea
              name="message"
              placeholder="Tell us a bit about what you need, and we'll get back to you shortly."
              rows="3"
              class="w-full px-4 py-3 rounded-lg bg-secondary-900 border border-secondary-700 text-white placeholder-secondary-400 focus:outline-none focus:ring-2 focus:ring-evergreen-primary resize-none text-sm"
            ></textarea>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-evergreen-primary hover:bg-evergreen-600 text-white py-3.5 rounded-full font-bold text-base transition-colors mt-2"
          >
            Send
          </button>
        </form>
      </div>
    </div>

    <!-- Right Side - Image -->
    <div class="w-1/2 h-full relative">
      <!-- Close Button -->
      <button
        id="modal-close-btn"
        class="absolute top-4 right-4 z-10 w-10 h-10 bg-evergreen-primary hover:bg-evergreen-600 rounded-full flex items-center justify-center transition-colors"
        aria-label="Close modal"
      >
        <svg
          class="w-5 h-5 text-white"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Image -->
      <img
        src={plumberImage.src}
        alt="Plumber at work"
        class="w-full h-full object-cover"
      />
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById("contact-modal");
  const backdrop = document.getElementById("modal-backdrop");
  const closeBtn = document.getElementById("modal-close-btn");
  const form = document.getElementById("contact-form-modal") as HTMLFormElement;

  // Open modal
  (window as any).openContactModal = () => {
    modal?.classList.remove("hidden");
    modal?.classList.add("flex");
    document.body.style.overflow = "hidden";
  };

  // Close modal
  const closeModal = () => {
    modal?.classList.add("hidden");
    modal?.classList.remove("flex");
    document.body.style.overflow = "";
  };

  closeBtn?.addEventListener("click", closeModal);
  backdrop?.addEventListener("click", closeModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
      closeModal();
    }
  });

  // Form submission to Payload
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data = {
      firstName: formData.get("firstName"),
      lastName: formData.get("lastName"),
      email: formData.get("email"),
      phone: formData.get("phone"),
      postalCode: formData.get("postalCode"),
      message: formData.get("message"),
    };

    console.log("Sending data:", data);
    console.log(
      "URL:",
      `${import.meta.env.PUBLIC_API_URL}/api/contact-submissions`,
    );

    try {
      const response = await fetch(
        `${import.meta.env.PUBLIC_API_URL}/api/contact-submissions`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        },
      );

      const result = await response.json();
      console.log("Response:", result);

      if (response.ok) {
        alert("Message sent successfully!");
        form.reset();
        closeModal();
      } else {
        console.error("Error response:", result);
        alert("Error sending message. Please try again.");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error sending message. Please try again.");
    }
  });
</script>
